---
name: anki-enrich
description: >
  Enrich Anki spelling cards with AI-generated definitions, phonetics, synonyms,
  example sentences, TTS audio, and cartoon illustrations. Also extracts words
  from spelling worksheet photos. Requires the Anki enrichment portal running
  (configure API URL in config.json).
allowed-tools: Bash, Read
argument-hint: "[words or noteIds to enrich]"
---

# Anki Enrichment Skill

Enrich Anki spelling cards with AI-generated content via the Anki Spelling Portal API.

## Setup

Edit `config.json` in this skill directory to point to the running portal:

```json
{
  "apiUrl": "http://localhost:3000"
}
```

For NAS/Docker deployments, use the appropriate URL (e.g., `http://nas.local:3000`).

## Intent Mapping

Match the user's intent to the appropriate script:

| User wants... | Script | Example |
|---|---|---|
| Enrich words with text (definitions, phonetics, etc.) | `enrich-text.mjs` | "add definitions for adventure and magnificent" |
| Generate audio for words | `enrich-audio.mjs` | "generate TTS audio for these cards" |
| Generate images for words | `enrich-image.mjs` | "create illustrations for my spelling cards" |
| Full enrichment (text + audio + image) | `enrich-full.mjs` | "enrich adventure and magnificent" |
| Extract words from worksheet photos | `extract-worksheet.mjs` | "extract words from this worksheet photo" |
| Extract AND enrich from worksheets | `extract-worksheet.mjs --enrich` | "process this spelling worksheet" |

**Default**: If the user just says "enrich [words]" without specifying what, use `enrich-full.mjs`.

## Script Invocations

All scripts are in `skill/scripts/`. Run with `node`:

### Full enrichment (most common)
```bash
node skill/scripts/enrich-full.mjs --words "adventure,magnificent"
node skill/scripts/enrich-full.mjs --noteIds 1234567890,1234567891
```

### Text only
```bash
node skill/scripts/enrich-text.mjs --words "adventure,magnificent"
node skill/scripts/enrich-text.mjs --words "adventure" --fields definition,phonetic
```

### Audio only
```bash
node skill/scripts/enrich-audio.mjs --words "adventure,magnificent"
```

### Image only
```bash
node skill/scripts/enrich-image.mjs --words "adventure,magnificent"
```

### Extract from worksheet
```bash
node skill/scripts/extract-worksheet.mjs --images /path/to/page.jpg
node skill/scripts/extract-worksheet.mjs --images /path/to/p1.jpg,/path/to/p2.jpg --enrich
```

## Arguments

- `--words "word1,word2"` — Comma-separated words. Scripts resolve these to Anki note IDs.
- `--noteIds 123,456` — Comma-separated Anki note IDs (use when IDs are already known).
- `--fields field1,field2` — (enrich-text only) Override default fields. Options: `sentence`, `definition`, `phonetic`, `synonyms`, `extra_info`.
- `--images path1,path2` — (extract-worksheet only) Image file paths.
- `--enrich` — (extract-worksheet only) After extraction, auto-create notes and run full enrichment.

## Fields Reference

### Text fields (generated by AI)
- **sentence** — Example sentence using the word
- **definition** — Word definition
- **phonetic** — IPA phonetic transcription
- **synonyms** — Comma-separated synonyms
- **extra_info** — Extra context (etymology, usage notes, etc.)

### Media fields
- **audio** — Word pronunciation (Azure TTS, MP3)
- **sentence_audio** — Full sentence pronunciation (Azure TTS, MP3)
- **image** — Cartoon illustration (Gemini API)

## Output Format

All scripts output JSON to stdout with this structure:

```json
{
  "results": [
    { "noteId": 123, "word": "adventure", "fields": ["Definition", "Phonetic symbol", ...] },
    { "noteId": 456, "word": "magnificent", "error": "reason" }
  ],
  "succeeded": 1,
  "failed": 1
}
```

Progress messages go to stderr. Parse stdout for the JSON summary.

## Exit Codes
- **0** — All succeeded
- **1** — Partial success (some cards failed)
- **2** — Total failure (no cards enriched, or fatal error)

## Error Handling

If you see "Cannot reach Anki portal", the portal server isn't running or `config.json` points to the wrong URL. If you see "AnkiConnect unreachable", Anki desktop isn't running or AnkiConnect plugin isn't installed.

## Environment Variable Override

For one-off testing, override the API URL without editing config.json:
```bash
ANKI_PORTAL_URL=http://other-host:3000 node skill/scripts/enrich-full.mjs --words "test"
```
